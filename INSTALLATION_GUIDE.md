# DWG2RVT - Revit Plugin for DWG Analysis

## Описание
Плагин для Autodesk Revit 2024, предназначенный для анализа импортированных DWG файлов и извлечения информации о блоках с их координатами.

## Структура проекта

### Основные компоненты:
- **App.cs** - Точка входа плагина, создает кнопку на панели Revit
- **Commands/OpenPanelCommand.cs** - Команда для открытия панели управления
- **UI/dwg2rvtPanel.xaml/.cs** - Панель управления плагином (WPF окно)
- **Core/DWGAnalyzer.cs** - Логика анализа DWG файлов

## Функциональность

### Панель управления
- Отображение имени активного вида
- Выбор импортированного DWG файла для анализа
- Кнопка "Анализ" для запуска процесса
- Область статуса для отображения прогресса

### Анализ DWG
Для каждого объекта в выбранном импортированном файле извлекаются:
- Номер объекта
- Имя блока
- Координаты границ (X, Y для верхней, нижней, левой и правой точек)
- Координата середины объекта

### Результаты
Создается лог-файл в формате `.txt` в директории:
`C:\Users\Свеж как огурец\Desktop\Эксперимент Annotatix\logs`

**Обновлено в версии 1.05+**: Директория логов изменена с `dwg2rvt\logs` на `logs` в родительской папке.

### Группировка геометрии (версия 1.05+)
Плагин автоматически группирует близлежащие геометрические элементы (линии, дуги) в единые блоки:
- **Розетки**: Определяются как комбинация дуг и линий
- **Светильники**: Определяются как несколько линий без дуг
- Порог близости: 0.5 футов (~15 см)

В логе отображается:
- Количество сгруппированных элементов
- Типы компонентов (например: "1 Arc(s), 3 Line(s)")
- Общие границы сгруппированного объекта
- Центральная точка объекта

## Система сборки

### Автоматическая версионность
При каждой сборке:
1. Инкрементируется номер билда в файле `BuildNumber.txt`
2. Создается папка `dwg2rvt_ver1.0X` (где X - номер билда)
3. В папке размещаются:
   - `dwg2rvt.addin` - файл манифеста плагина
   - `dwg2rvtdependencies/` - DLL и зависимости для работы
   - `dwg2rvt-dll/` - полный вывод сборки (для отладки через Add-in Manager)

### Структура версионных папок:
```
dwg2rvt_ver1.01/
├── dwg2rvt.addin
├── dwg2rvtdependencies/
│   ├── dwg2rvt.dll
│   └── dwg2rvt.pdb
└── dwg2rvt-dll/
    ├── dwg2rvt.dll
    └── dwg2rvt.pdb
```

## Установка

### Вариант 1: Установка в Revit (рекомендуется)
1. Скопируйте папку `dwg2rvtdependencies` из последней версии в:
   `C:\Users\Свеж как огурец\AppData\Roaming\Autodesk\Revit\Addins\2024\`

2. Скопируйте файл `dwg2rvt.addin` в:
   `C:\Users\Свеж как огурец\AppData\Roaming\Autodesk\Revit\Addins\2024\`

3. Перезапустите Revit

4. Плагин появится на вкладке "DWG2RVT" на ленте Revit

### Вариант 2: Отладка через Revit Add-in Manager
1. Установите Revit Add-in Manager (если не установлен)
2. Используйте файлы из папки `dwg2rvt-dll`
3. Загрузите `dwg2rvt.dll` через Add-in Manager для быстрого тестирования

## Сборка проекта

### Требования:
- .NET Framework 4.8
- Revit API 2024
- Visual Studio 2022 или .NET SDK

### Команды сборки:

**ВАЖНО: Используйте `build.bat` для правильной сборки с автоматическим версионированием!**

```bash
# Рекомендуемый способ сборки (создает версионную папку автоматически)
.\build.bat
```

Скрипт `build.bat` выполняет:
1. Очистку предыдущей сборки
2. Инкремент номера билда
3. Сборку проекта
4. Создание версионной папки `dwg2rvt_ver1.XX` в родительской директории
5. Копирование всех необходимых файлов

```powershell
# Альтернативный способ (НЕ создает версионную папку автоматически)
dotnet build --configuration Debug

# Очистка
dotnet clean
```

### Скрипты автоматизации:
- **IncrementBuildNumber.ps1** - Инкрементирует номер билда (выполняется перед сборкой)
- **PostBuild.ps1** - Создает структуру версионных папок (выполняется после сборки)

## Использование

1. Откройте проект в Revit 2024
2. Перейдите на вид с импортированным DWG файлом
3. На панели Revit выберите вкладку "DWG2RVT"
4. Нажмите кнопку "DWG Analysis Panel"
5. В открывшемся окне:
   - Проверьте имя активного вида
   - Выберите импортированный файл из списка
   - Нажмите "Analyze"
6. После завершения анализа откроется сообщение с результатами
7. Лог-файл будет сохранен в папку `logs`

## Структура лог-файла
```
=======================================================
           DWG2RVT - Analysis Report
=======================================================
Analysis Date: 2025-12-24 18:00:00
Import File: [имя файла]
Import ID: [ID]
Total Blocks Analyzed: [количество]
=======================================================

Block Details:
-------------

Object Number: 1
  Block Name: [имя блока]
  Coordinates:
    Left (X):   [значение] ft
    Right (X):  [значение] ft
    Bottom (Y): [значение] ft
    Top (Y):    [значение] ft
  Center Point:
    X: [значение] ft
    Y: [значение] ft
...
```

## Разработка

### Добавление новой функциональности:
1. Модифицируйте соответствующие файлы
2. Соберите проект
3. Новая версия автоматически создастся в папке `dwg2rvt_ver1.0X`
4. Скопируйте файлы из новой версии для установки

### Отладка:
- Используйте Revit Add-in Manager для быстрой загрузки изменений
- Файлы для отладки находятся в `dwg2rvt-dll` каждой версии
- Логи создаются в реальном времени в папке `logs`

## Технические детали

### Версия Revit: 2024
### Целевой Framework: .NET Framework 4.8
### Язык: C#
### UI Framework: WPF

### Зависимости:
- RevitAPI.dll
- RevitAPIUI.dll
- PresentationCore
- PresentationFramework
- WindowsBase
- System.Xaml

## Примечания

- Плагин работает только с активным видом
- Поддерживаются как связанные, так и импортированные DWG файлы
- Координаты выводятся в футах (единицы Revit по умолчанию)
- Каждый анализ создает отдельный лог-файл с меткой времени
- **Важно**: Имена файлов автоматически очищаются от недопустимых символов (версия 1.03+)

## История изменений

### Версия 1.08 (текущая)
- **Добавлено**: Скрипт `build.bat` для автоматической сборки с версионированием
- **Исправлено**: Post-build скрипты теперь выполняются корректно

### Версия 1.05
- **Добавлено**: Группировка геометрии - отдельные линии и дуги теперь группируются в единые объекты (розетки, светильники)
- **Добавлено**: Автоматическое определение типа объекта по геометрии
- **Изменено**: Директория логов перенесена в `C:\Users\Свеж как огурец\Desktop\Эксперимент Annotatix\logs`
- **Добавлено**: Лог теперь отображает количество и типы геометрических элементов в каждом блоке

### Версия 1.03
- **Исправлено**: Ошибка создания лог-файла "Путь содержит недопустимые знаки"
- Добавлена автоматическая очистка имен файлов от недопустимых символов
- Улучшена обработка специальных символов в именах импортированных файлов

### Версия 1.02
- Первоначальный релиз с полным функционалом

### Версия 1.01
- Начальная версия

## Контакты
Для вопросов и предложений обращайтесь к разработчику.
